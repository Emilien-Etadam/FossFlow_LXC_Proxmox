#!/usr/bin/env bash

# Copyright (c) 2021-2025 community-scripts ORG
# Author: Emilien-Etadam
# License: MIT | https://github.com/Emilien-Etadam/FossFlow_LXC_Proxmox/raw/main/LICENSE
# Source: https://github.com/stan-smith/FossFLOW

set -e

# Color codes
BL='\033[36m'
GN='\033[1;92m'
RD='\033[01;31m'
CL='\033[m'

function msg_info() {
  echo -e "${BL}[INFO]${CL} $1"
}

function msg_ok() {
  echo -e "${GN}[OK]${CL} $1"
}

function msg_error() {
  echo -e "${RD}[ERROR]${CL} $1"
}

msg_info "Starting FossFLOW installation"

msg_info "Updating system"
apt-get update &>/dev/null
apt-get upgrade -y &>/dev/null
msg_ok "System updated"

msg_info "Installing Dependencies"
apt-get install -y \
  curl \
  git \
  ca-certificates \
  gnupg &>/dev/null
msg_ok "Installed Dependencies"

msg_info "Installing Node.js 20.x"
bash -c "$(curl -fsSL https://deb.nodesource.com/setup_20.x)" &>/dev/null
apt-get install -y nodejs &>/dev/null
msg_ok "Installed Node.js $(node -v)"

msg_info "Installing FossFLOW"
RELEASE=$(curl -fsSL https://api.github.com/repos/stan-smith/FossFLOW/releases/latest | grep "tag_name" | awk '{print substr($2, 3, length($2)-4)}')
msg_info "Downloading FossFLOW v${RELEASE}"
cd /opt
git clone -b "v${RELEASE}" --depth 1 https://github.com/stan-smith/FossFLOW.git fossflow &>/dev/null
cd /opt/fossflow

msg_info "Building FossFLOW (this may take 5-10 minutes)"
npm install &>/dev/null
npm run build:lib &>/dev/null
npm run build:app &>/dev/null
echo "${RELEASE}" >/opt/FossFLOW_version.txt
msg_ok "Installed FossFLOW v${RELEASE}"

msg_info "Installing serve for frontend"
npm install -g serve &>/dev/null
msg_ok "Installed serve"

msg_info "Creating Data Directory"
mkdir -p /opt/fossflow-data/diagrams
msg_ok "Created Data Directory"

msg_info "Creating Backend Service"
cat <<EOF >/etc/systemd/system/fossflow-backend.service
[Unit]
Description=FossFLOW Backend API
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/fossflow/packages/fossflow-backend
Environment=NODE_ENV=production
Environment=BACKEND_PORT=3001
Environment=ENABLE_SERVER_STORAGE=true
Environment=STORAGE_PATH=/opt/fossflow-data/diagrams
ExecStart=/usr/bin/node server.js
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
msg_ok "Created Backend Service"

msg_info "Creating Frontend Service"
cat <<EOF >/etc/systemd/system/fossflow-frontend.service
[Unit]
Description=FossFLOW Frontend
After=network.target fossflow-backend.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/fossflow/packages/fossflow-app/dist
Environment=NODE_ENV=production
ExecStart=/usr/local/bin/serve -s . -l 3000 --no-port-switching
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
msg_ok "Created Frontend Service"

msg_info "Starting Services"
systemctl daemon-reload
systemctl enable --now fossflow-backend &>/dev/null
systemctl enable --now fossflow-frontend &>/dev/null
msg_ok "Services Started"

msg_info "Cleaning up"
apt-get -y autoremove &>/dev/null
apt-get -y autoclean &>/dev/null
msg_ok "Cleaned"

msg_ok "FossFLOW installation completed!"
